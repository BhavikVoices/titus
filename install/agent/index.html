
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.5.4">
    
    
      
        <title>Agent - Titus</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-b1a1975878.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Titus" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Deployment
                </span>
              
            
            Agent
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/Netflix/titus" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Titus
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/Netflix/titus" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../build/" title="Building the Code" class="md-nav__link">
      Building the Code
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Deployment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../prereqs/" title="Prereqs" class="md-nav__link">
      Prereqs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../prereqs-amazon/" title="Amazon Prereqs" class="md-nav__link">
      Amazon Prereqs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../master/" title="Master and Gateway" class="md-nav__link">
      Master and Gateway
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
    <a href="./" title="Agent" class="md-nav__link md-nav__link--active">
      Agent
    </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Testing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Testing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../test/batch/" title="Basic batch task" class="md-nav__link">
      Basic batch task
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Netflix/titus/edit/master/docs/install/agent.md" title="Edit this page" class="md-icon md-content__icon">edit</a>
                
                
                <h1 id="using-cloud-init">Using Cloud-init</h1>
<p>We recommend that you use the following cloud-init config with Ubuntu 16.04. Just make sure you've added an IAM role to your profile: <a href="../cloud-init.yml">cloud-init</a>. There are a few fields we recommend filling in for yourself here. For example, you should fill in your SSH keys, and not ours. Also, you should configure the <code>/etc/mesos-attributes.sh</code> config file that's included in the cloud-init to be suited for your instance. The mesos-specific configuration that needs to be adjusted is the <code>stack</code>, <code>asg</code>, and <code>Res</code> attributes. You will also need to edit the run_cmd section, and change <code>zk://172.31.0.136:2181/titus/mainvpc/mesos</code>, based on your Zookeeper configuration. The specifics of the <code>Res</code> attribute, and how it refers to how your ENIs work is explained below.</p>
<p>In order to use cloud-init, you need to go ahead and paste the linked yaml file into your Ubuntu 16.04 VM's user data.</p>
<h1 id="manual-install">Manual Install</h1>
<p>This is for advanced users only. We do not recommend using these instructions unless you're running a customized system. We also recommend looking at the cloud-init as the reference for canonical configuration files.</p>
<h2 id="linux">Linux</h2>
<p>We recommend Ubuntu Linux, Xenial, with a 4.4 or newer version for running Titus. We also recommend this for developing Titus agent itself. We recommend using XFS or Btrfs for the storage of the Docker daemon itself, and separating out the storage of the agent "Control Plane" components versus the non-control plane components. </p>
<h2 id="install-packagecloud-repo">Install Packagecloud Repo</h2>
<p>Run the following commands:</p>
<pre><code>curl -s https://8095c452e9473a3fae3ea86a6f2572c2cde0d7b5ec63e84f:@packagecloud.io/install/repositories/netflix/titus/script.deb.sh | sudo bash
apt-get update
</code></pre>

<h2 id="install-docker">Install Docker</h2>
<p>Install docker as instructed <a href="https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/#install-using-the-repository">here</a></p>
<ul>
<li>Add the current user to docker group <code>sudo gpasswd -a $USER docker</code>, log out and then log back in.</li>
</ul>
<p>You can add the following drop-in systemd unit to configure Docker for your needs:</p>
<pre><code># /etc/systemd/system/docker.service.d/10-docker-config.conf
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --log-level=debug -H fd:// --init-path=/apps/titus-executor/bin/tini-static --iptables=false --storage-driver=overlay2
Restart=always
StartLimitInterval=0
RestartSec=5
</code></pre>

<p>You should also configure the Docker TCP Proxy, with the following systemd units:</p>
<h3 id="docker-tcp-proxyservice">docker-tcp-proxy.service</h3>
<pre><code># /lib/systemd/system/docker-tcp-proxy.service
[Unit]
Description=Docker Unix Socket TCP Proxy
Requires=docker.socket
Requires=docker-tcp-proxy.socket
After=docker.socket
After=docker-tcp-proxy.socket

[Service]
ExecStart=/lib/systemd/systemd-socket-proxyd /var/run/docker.sock

[Install]
WantedBy=multi-user.target
</code></pre>

<h3 id="docker-tcp-proxysocket">docker-tcp-proxy.socket</h3>
<pre><code># /lib/systemd/system/docker-tcp-proxy.socket
[Unit]
Requires=docker.socket
After=docker.socket

[Socket]
ListenStream=0.0.0.0:4243

[Install]
WantedBy=sockets.target
</code></pre>

<p>Once you've done this, we recommend restarting docker, enabling these systemd units to restart on every boot.</p>
<h1 id="mesos-agent">Mesos-agent</h1>
<p>You can download Mesos from Mesosphere's OSS site here: https://open.mesosphere.com/downloads/mesos/#apache-mesos-1.1.3, we recommend installing 1.1.3. You can download the deb directly <a href="../here">http://repos.mesosphere.com/ubuntu/pool/main/m/mesos/mesos_1.1.3-2.0.1.ubuntu1604_amd64.deb</a>.</p>
<p>Unfortunately, Mesos does not come with a systemd unit file out of the box, so we have one that you can adapt to your own needs:</p>
<pre><code># /lib/systemd/system/mesos-agent.service
[Unit]
Description=Mesos
Wants=docker.service
After=docker.service
Conflicts=halt.target shutdown.target sigpwr.target

[Service]
ExecStartPre=/bin/mkdir -p /var/lib/mesos
EnvironmentFile=/etc/mesos-agent.config
ExecStart=/usr/sbin/mesos-agent
ExecStopPost=/bin/rm -rf /var/lib/mesos/meta/slaves/latest
Restart=always
StartLimitInterval=0
RestartSec=5
LimitNOFILE=65535
KillMode=mixed
KillSignal=SIGUSR1

[Install]
WantedBy=multi-user.target
</code></pre>

<p>Our <code>/etc/mesos-agent.config</code> includes the following:</p>
<pre><code>MESOS_MASTER=zk://1.1.1.1:2181,2.2.2.2:2181/titus/devvpc7/mesos
MESOS_PORT=7101
MESOS_RECOVER=reconnect
MESOS_WORK_DIR=/var/lib/mesos
MESOS_STRICT=false
MESOS_RESOURCES=ports:[7150-7200];mem:230400;disk:523264;network:9000
MESOS_ATTRIBUTES=region:us-east-1;asg:titusagent-devvpc7-r4.8xlarge-v072;stack:devvpc7;zone:us-east-1c;itype:r4.8xlarge;cluster:titusagent-devvpc7-r4.8xlarge;id:i-0d736710f99b183f1;res:ResourceSet-ENIs-7-29;distcodename:xenial;distrelease:16.04
</code></pre>

<p>Of course, adapt the configuration file to your needs. The Mesos attributes are broken down as below:</p>
<ul>
<li>region: AWS region</li>
<li>asg: AWS ASG name</li>
<li>stack: Which (isolated) Titus environment</li>
<li>zone: Which AWS availabilityzone</li>
<li>itype: What AWS instance type</li>
<li>cluster: This is an internal naming convention of titusagent-${stack}-${custom}</li>
<li>id: EC2 instance identifier</li>
<li>res: Special construction to signal to the Titus master how many ENIs this instance type can handle, for example "ResourceSet-ENIs-7-29", means that this machine can have 7 additional ENIs, and 29 IPs per ENI.</li>
</ul>
<h1 id="vpc-driver">VPC Driver</h1>
<p>Install the VPC Driver from the repo. The name of the package is <code>titus-vpc-driver</code>.
<em> Add <code>net.ifnames=0</code> to GRUB_CMDLINE_LINUX= in <code>/etc/default/grub</code> and then run <code>sudo update-grub</code>.
</em> Remove the <code>/etc/udev/rules.d/70-persistent-net.rules</code> file and then run <code>sudo reboot</code>.
* After reboot, the default interface should be named <code>eth0</code> instead of the previous <code>ens3</code>.</p>
<h1 id="titus-executor">titus-executor</h1>
<p>Install the VPC Driver from the repo. The name of the package is <code>titus-executor</code>.</p>
<p>You need to configure it with a configuration file at <code>/etc/titus-executor/config.json</code>. The configuration file looks like below:</p>
<pre><code>{
  &quot;stack&quot;: &quot;mainvpc&quot;,
  &quot;docker&quot;: {
    &quot;host&quot;: &quot;tcp://127.0.0.1:4243&quot;,
    &quot;registry&quot;: &quot;docker.io&quot;
  },
  &quot;uploaders&quot;: {
     },
  &quot;env&quot;: {
    &quot;copiedFromHost&quot;: [
      &quot;NETFLIX_ENVIRONMENT&quot;,
      &quot;NETFLIX_ACCOUNT&quot;,
      &quot;NETFLIX_STACK&quot;,
      &quot;EC2_INSTANCE_ID&quot;,
      &quot;EC2_REGION&quot;,
      &quot;EC2_AVAILABILITY_ZONE&quot;,
      &quot;EC2_OWNER_ID&quot;,
      &quot;EC2_VPC_ID&quot;,
      &quot;EC2_RESERVATION_ID&quot;
    ],
    &quot;hardCoded&quot;: {
      &quot;NETFLIX_APPUSER&quot;: &quot;appuser&quot;,
      &quot;EC2_DOMAIN&quot;: &quot;amazonaws.com&quot;
    }
  },
  &quot;statusCheckFrequency&quot;: &quot;10s&quot;,
  &quot;useNewNetworkDriver&quot;: true,
  &quot;usePrivilegedTasks&quot;: false,
  &quot;useMetatron&quot;: true,
  &quot;logsTmpDir&quot;: &quot;/var/lib/titus-container-logs&quot;
}
</code></pre>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../master/" title="Master and Gateway" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Master and Gateway
              </span>
            </div>
          </a>
        
        
          <a href="../../test/batch/" title="Basic batch task" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Basic batch task
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-0b7df094bf.js"></script>
      <script>app.initialize({url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>